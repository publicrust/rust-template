using System.Timers;
using Oxide.Core;
using Oxide.Ext.Discord.Clients;
using Oxide.Ext.Discord.Interfaces;
using Oxide.Ext.Discord.Logging;
using Oxide.Ext.Discord.WebSockets;

public class DiscordHeartbeatHandler
{
	private bool _heartbeatAcknowledged;

	private readonly BotClient _client;

	private readonly DiscordWebSocket _socket;

	private readonly ILogger _logger;

	private Timer _timer;

	private float _interval;

	private bool _initial;

	public DiscordHeartbeatHandler(BotClient client, DiscordWebSocket socket, ILogger logger)
	{
		_client = client;
		_socket = socket;
		_logger = logger;
		_timer = new Timer();
		_timer.Elapsed += HeartbeatElapsed;
	}

	internal void SetupHeartbeat(float interval)
	{
		_timer.Stop();
		_heartbeatAcknowledged = true;
		_interval = interval;
		_initial = true;
		_timer.Interval = _interval * Random.Range(0f, 1f);
		_timer.Start();
		_logger.Debug("DiscordHeartbeatHandler.SetupHeartbeat Creating heartbeat with interval {0}ms.", interval);
		_client.Hooks.CallHook("OnDiscordSetupHeartbeat", interval);
	}

	internal void OnHeartbeatAcknowledge()
	{
		_heartbeatAcknowledged = true;
	}

	public void OnSocketShutdown()
	{
		if (_timer != null)
		{
			_logger.Debug("DiscordHeartbeatHandler.OnSocketShutdown Destroy Heartbeat");
			_timer.Dispose();
			_timer = null;
		}
	}

	private void HeartbeatElapsed(object sender, ElapsedEventArgs e)
	{
		_logger.Verbose("DiscordHeartbeatHandler.HeartbeatElapsed Heartbeat Elapsed");
		if (_initial)
		{
			_timer.Interval = _interval;
			_initial = false;
		}
		if (!_socket.SocketHasConnected)
		{
			_logger.Debug("DiscordHeartbeatHandler.HeartbeatElapsed Websocket has not yet connected successfully. Skipping Heartbeat.");
		}
		else if (_socket.IsPendingReconnect())
		{
			_logger.Debug("DiscordHeartbeatHandler.HeartbeatElapsed Websocket is offline and is waiting to connect.");
		}
		else if (_socket.IsDisconnected())
		{
			_logger.Debug("DiscordHeartbeatHandler.HeartbeatElapsed Websocket is offline and is NOT connecting. Attempt Reconnect.");
			_socket.ShouldReconnect = true;
			_socket.ReconnectIfRequested();
		}
		else if (_socket.IsDisconnecting())
		{
			_logger.Debug("DiscordHeartbeatHandler.HeartbeatElapsed Websocket is currently in the process of disconnecting");
		}
		else if (!_heartbeatAcknowledged)
		{
			if (_socket.IsConnected())
			{
				_logger.Debug("DiscordHeartbeatHandler.HeartbeatElapsed Heartbeat Elapsed and WebSocket is connected. Forcing reconnect.");
				_socket.Disconnect(reconnect: true, resume: true, requested: true);
			}
			else if (!_socket.IsConnecting() && !_socket.IsPendingReconnect())
			{
				_logger.Debug("DiscordHeartbeatHandler.HeartbeatElapsed Heartbeat Elapsed and bot is not online or connecting.");
				_socket.ShouldReconnect = true;
				_socket.ReconnectIfRequested();
			}
			else
			{
				_logger.Debug("DiscordHeartbeatHandler.HeartbeatElapsed Heartbeat Elapsed and bot is not online but is waiting to connecting or waiting to reconnect.");
			}
		}
		else
		{
			SendHeartbeat();
		}
	}

	private void SendHeartbeat()
	{
		_heartbeatAcknowledged = false;
		_socket.SendHeartbeat();
		_client.Hooks.CallHook("OnDiscordHeartbeatSent");
		_logger.Verbose("Heartbeat sent - {0}ms interval.", _timer.Interval);
	}
}
