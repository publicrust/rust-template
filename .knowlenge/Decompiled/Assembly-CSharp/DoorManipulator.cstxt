using System;
using System.Collections.Generic;
using Facepunch;
using UnityEngine;

public class DoorManipulator : IOEntity
{
	public enum DoorEffect
	{
		Close,
		Open,
		Toggle
	}

	public EntityRef entityRef;

	public Door targetDoor;

	public DoorEffect powerAction;

	private bool toggle = true;

	public virtual bool CanPairWithLockedDoors()
	{
		return true;
	}

	public override void Init()
	{
		base.Init();
		SetupInitialDoorConnection();
	}

	public virtual void SetupInitialDoorConnection()
	{
		if ((Object)(object)targetDoor == (Object)null && !entityRef.IsValid(serverside: true))
		{
			SetTargetDoor(FindDoor(CanPairWithLockedDoors()));
		}
		if ((Object)(object)targetDoor != (Object)null && !entityRef.IsValid(serverside: true))
		{
			entityRef.Set(targetDoor);
		}
		if (entityRef.IsValid(serverside: true) && (Object)(object)targetDoor == (Object)null)
		{
			SetTargetDoor(((Component)entityRef.Get(serverside: true)).GetComponent<Door>());
		}
	}

	public virtual void SetTargetDoor(Door newTargetDoor)
	{
		Door door = targetDoor;
		targetDoor = newTargetDoor;
		SetFlag(Flags.On, (Object)(object)targetDoor != (Object)null);
		entityRef.Set(newTargetDoor);
		if ((Object)(object)door != (Object)(object)targetDoor && (Object)(object)targetDoor != (Object)null)
		{
			DoAction(powerAction);
		}
	}

	public virtual Door FindDoor(bool allowLocked = true)
	{
		//IL_000c: Unknown result type (might be due to invalid IL or missing references)
		//IL_007a: Unknown result type (might be due to invalid IL or missing references)
		//IL_0085: Unknown result type (might be due to invalid IL or missing references)
		List<Door> list = Pool.Get<List<Door>>();
		Vis.Entities(((Component)this).transform.position, 1f, list, 2097152, (QueryTriggerInteraction)1);
		Door result = null;
		float num = float.PositiveInfinity;
		foreach (Door item in list)
		{
			if (!item.isServer)
			{
				continue;
			}
			if (!allowLocked)
			{
				BaseLock baseLock = item.GetSlot(Slot.Lock) as BaseLock;
				if ((Object)(object)baseLock != (Object)null && baseLock.IsLocked())
				{
					continue;
				}
			}
			if (!item.IsOnMovingObject())
			{
				float num2 = Vector3.Distance(((Component)item).transform.position, ((Component)this).transform.position);
				if (num2 < num)
				{
					result = item;
					num = num2;
				}
			}
		}
		Pool.FreeUnmanaged<Door>(ref list);
		return result;
	}

	public virtual void DoActionDoorMissing()
	{
		SetTargetDoor(FindDoor(CanPairWithLockedDoors()));
	}

	public virtual void DoAction(DoorEffect action)
	{
		bool flag = IsPowered();
		if ((Object)(object)targetDoor == (Object)null)
		{
			DoActionDoorMissing();
		}
		if (!((Object)(object)targetDoor != (Object)null))
		{
			return;
		}
		if (targetDoor.IsBusy())
		{
			((FacepunchBehaviour)this).Invoke((Action)delegate
			{
				DoAction(action);
			}, 1f);
		}
		else if (action == DoorEffect.Open)
		{
			if (flag)
			{
				if (!targetDoor.IsOpen())
				{
					targetDoor.SetOpen(open: true);
				}
			}
			else if (targetDoor.IsOpen())
			{
				targetDoor.SetOpen(open: false);
			}
		}
		else if (action == DoorEffect.Close)
		{
			if (flag)
			{
				if (targetDoor.IsOpen())
				{
					targetDoor.SetOpen(open: false);
				}
			}
			else if (!targetDoor.IsOpen())
			{
				targetDoor.SetOpen(open: true);
			}
		}
		else if (action == DoorEffect.Toggle)
		{
			if (flag && toggle)
			{
				targetDoor.SetOpen(!targetDoor.IsOpen());
				toggle = false;
			}
			else if (!toggle)
			{
				toggle = true;
			}
		}
	}

	public override void IOStateChanged(int inputAmount, int inputSlot)
	{
		base.IOStateChanged(inputAmount, inputSlot);
		DoAction(powerAction);
	}

	public override void Save(SaveInfo info)
	{
		//IL_0018: Unknown result type (might be due to invalid IL or missing references)
		//IL_001d: Unknown result type (might be due to invalid IL or missing references)
		base.Save(info);
		info.msg.ioEntity.genericEntRef1 = entityRef.uid;
		info.msg.ioEntity.genericInt1 = (int)powerAction;
	}

	public override void Load(LoadInfo info)
	{
		//IL_0025: Unknown result type (might be due to invalid IL or missing references)
		base.Load(info);
		if (info.msg.ioEntity != null)
		{
			entityRef.uid = info.msg.ioEntity.genericEntRef1;
			powerAction = (DoorEffect)info.msg.ioEntity.genericInt1;
		}
	}
}
